P8105 Homework 6
================
Ruiyang Li
2020-12-05

This is my solution to HW6.

### Problem 1

``` r
homicide_df = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    city_state != "Tulsa, AL") %>% 
  dplyr::select(city_state, resolution, victim_age, victim_race, victim_sex)
## Parsed with column specification:
## cols(
##   uid = col_character(),
##   reported_date = col_double(),
##   victim_last = col_character(),
##   victim_first = col_character(),
##   victim_race = col_character(),
##   victim_age = col_double(),
##   victim_sex = col_character(),
##   city = col_character(),
##   state = col_character(),
##   lat = col_double(),
##   lon = col_double(),
##   disposition = col_character()
## )
```

Start with one city: Baltimore, MD.

``` r
baltimore_df =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")

glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  dplyr::select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
```

| term              |    OR | CI\_lower | CI\_upper |
| :---------------- | ----: | --------: | --------: |
| (Intercept)       | 1.363 |     0.975 |     1.907 |
| victim\_age       | 0.993 |     0.987 |     1.000 |
| victim\_raceWhite | 2.320 |     1.648 |     3.268 |
| victim\_sexMale   | 0.426 |     0.325 |     0.558 |

Try this across cities.

``` r
models_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  dplyr::select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  dplyr::select(city_state, term, OR, starts_with("CI")) 
```

Create a plot that shows the estimated ORs and CIs for each city.

``` r
models_results_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

<img src="p8105_hw6_rl3034_files/figure-gfm/or_plt-1.png" width="90%" />

## Problem 2

Load and clean the data for regression analysis (i.e. convert numeric to
factor where appropriate, check for missing data, etc.).

  - There is no missing data observed.

<!-- end list -->

``` r
# Inspect the data
#read_csv("./data/birthweight.csv") %>% sample_n(3) 

baby_df = 
  read_csv("./data/birthweight.csv") %>% 
  mutate(
    babysex = factor(babysex), 
    frace = factor(frace), 
    malform = factor(malform), 
    mrace = factor(mrace)
    )
## Parsed with column specification:
## cols(
##   .default = col_double()
## )
## See spec(...) for full column specifications.

# counting missing values
# total na count
baby_df %>%
  summarise(na_count = sum(is.na(.)))
## # A tibble: 1 x 1
##   na_count
##      <int>
## 1        0
# variable-wise na%
baby_df %>%
  summarise_all(list(~sum(is.na(.))))/nrow(baby_df)
##   babysex bhead blength bwt delwt fincome frace gaweeks malform menarche
## 1       0     0       0   0     0       0     0       0       0        0
##   mheight momage mrace parity pnumlbw pnumsga ppbmi ppwt smoken wtgain
## 1       0      0     0      0       0       0     0    0      0      0

# check to dummy variables

#contrasts(baby_df$babysex)
#levels(baby_df$babysex)

#contrasts(baby_df$frace)
#levels(baby_df$frace)

#contrasts(baby_df$malform)
#levels(baby_df$malform)

#contrasts(baby_df$mrace)
#levels(baby_df$mrace)
```

Propose a regression model for birthweight. This model may be based on a
hypothesized structure for the factors that underly birthweight, on a
data-driven model-building process, or a combination of the two.
Describe your modeling process and show a plot of model residuals
against fitted values – use add\_predictions and add\_residuals in
making this plot.

  - We can use step-wise selection procedure to select our regression
    model.
  - The model that I propose for birthweight is: `bwt` = `\beta_0` +
    `\beta_1` `babysex2` + `\beta_2` `bhead` + `\beta_3` `blength` +
    `\beta_4` `delwt` + `\beta_5` `fincome` + `\beta_6` `gaweeks` +
    `\beta_7` `mheight` + `\beta_8` `mrace2` + `\beta_9` `mrace3` +
    `\beta_10` `mrace4` + `\beta_11` `parity` + `\beta_12` `ppwt` +
    `\beta_13` `smoken`
  - The step-wise selection procedure iteratively adds and/or removes
    important predictor based on AIC score.

<!-- end list -->

``` r
#library(olsrr)
#fit = lm(bwt ~ ., data = baby_df)
#ols_step_both_p(fit, pent = 0.15, prem = 0.15, details = T)


library(MASS)             # for stepAIC()

# Fit the full model 
full_mod = lm(bwt ~ ., data = baby_df)

# Stepwise regression model
step_mod = stepAIC(full_mod, direction = "both", trace = TRUE)
## Start:  AIC=48717.83
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     pnumlbw + pnumsga + ppbmi + ppwt + smoken + wtgain
## 
## 
## Step:  AIC=48717.83
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     pnumlbw + pnumsga + ppbmi + ppwt + smoken
## 
## 
## Step:  AIC=48717.83
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     pnumlbw + ppbmi + ppwt + smoken
## 
## 
## Step:  AIC=48717.83
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     ppbmi + ppwt + smoken
## 
##            Df Sum of Sq       RSS   AIC
## - frace     4    124365 320848704 48712
## - malform   1      1419 320725757 48716
## - ppbmi     1      6346 320730684 48716
## - momage    1     28661 320752999 48716
## - mheight   1     66886 320791224 48717
## - menarche  1    111679 320836018 48717
## - ppwt      1    131132 320855470 48718
## <none>                  320724338 48718
## - fincome   1    193454 320917792 48718
## - parity    1    413584 321137922 48721
## - mrace     3    868321 321592659 48724
## - babysex   1    853796 321578134 48727
## - gaweeks   1   4611823 325336161 48778
## - smoken    1   5076393 325800732 48784
## - delwt     1   8008891 328733230 48823
## - blength   1 102050296 422774634 49915
## - bhead     1 106535716 427260054 49961
## 
## Step:  AIC=48711.51
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     ppbmi + ppwt + smoken
## 
##            Df Sum of Sq       RSS   AIC
## - malform   1      1447 320850151 48710
## - ppbmi     1      6975 320855679 48710
## - momage    1     28379 320877083 48710
## - mheight   1     69502 320918206 48710
## - menarche  1    115708 320964411 48711
## - ppwt      1    133961 320982665 48711
## <none>                  320848704 48712
## - fincome   1    194405 321043108 48712
## - parity    1    414687 321263390 48715
## + frace     4    124365 320724338 48718
## - babysex   1    852133 321700837 48721
## - gaweeks   1   4625208 325473911 48772
## - smoken    1   5036389 325885093 48777
## - delwt     1   8013099 328861802 48817
## - mrace     3  13540415 334389119 48885
## - blength   1 101995688 422844392 49908
## - bhead     1 106662962 427511666 49956
## 
## Step:  AIC=48709.53
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     menarche + mheight + momage + mrace + parity + ppbmi + ppwt + 
##     smoken
## 
##            Df Sum of Sq       RSS   AIC
## - ppbmi     1      6928 320857079 48708
## - momage    1     28660 320878811 48708
## - mheight   1     69320 320919470 48708
## - menarche  1    116027 320966177 48709
## - ppwt      1    133894 320984044 48709
## <none>                  320850151 48710
## - fincome   1    193784 321043934 48710
## + malform   1      1447 320848704 48712
## - parity    1    414482 321264633 48713
## + frace     4    124393 320725757 48716
## - babysex   1    851279 321701430 48719
## - gaweeks   1   4624003 325474154 48770
## - smoken    1   5035195 325885346 48775
## - delwt     1   8029079 328879230 48815
## - mrace     3  13553320 334403471 48883
## - blength   1 102009225 422859375 49906
## - bhead     1 106675331 427525481 49954
## 
## Step:  AIC=48707.63
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     menarche + mheight + momage + mrace + parity + ppwt + smoken
## 
##            Df Sum of Sq       RSS   AIC
## - momage    1     29211 320886290 48706
## - menarche  1    117635 320974714 48707
## <none>                  320857079 48708
## - fincome   1    195199 321052278 48708
## + ppbmi     1      6928 320850151 48710
## + malform   1      1400 320855679 48710
## - parity    1    412984 321270064 48711
## + frace     4    125020 320732060 48714
## - babysex   1    850020 321707099 48717
## - mheight   1   1078673 321935752 48720
## - ppwt      1   2934023 323791103 48745
## - gaweeks   1   4621504 325478583 48768
## - smoken    1   5039368 325896447 48773
## - delwt     1   8024939 328882018 48813
## - mrace     3  13551444 334408523 48881
## - blength   1 102018559 422875638 49904
## - bhead     1 106821342 427678421 49953
## 
## Step:  AIC=48706.02
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     menarche + mheight + mrace + parity + ppwt + smoken
## 
##            Df Sum of Sq       RSS   AIC
## - menarche  1    100121 320986412 48705
## <none>                  320886290 48706
## - fincome   1    240800 321127090 48707
## + momage    1     29211 320857079 48708
## + ppbmi     1      7479 320878811 48708
## + malform   1      1678 320884612 48708
## - parity    1    431433 321317724 48710
## + frace     4    124743 320761547 48712
## - babysex   1    841278 321727568 48715
## - mheight   1   1076739 321963029 48719
## - ppwt      1   2913653 323799943 48743
## - gaweeks   1   4676469 325562760 48767
## - smoken    1   5045104 325931394 48772
## - delwt     1   8000672 328886962 48811
## - mrace     3  14667730 335554021 48894
## - blength   1 101990556 422876847 49902
## - bhead     1 106864308 427750598 49952
## 
## Step:  AIC=48705.38
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     mheight + mrace + parity + ppwt + smoken
## 
##            Df Sum of Sq       RSS   AIC
## <none>                  320986412 48705
## + menarche  1    100121 320886290 48706
## - fincome   1    245637 321232048 48707
## + momage    1     11698 320974714 48707
## + ppbmi     1      8823 320977589 48707
## + malform   1      1884 320984528 48707
## - parity    1    422770 321409181 48709
## + frace     4    128726 320857686 48712
## - babysex   1    846134 321832545 48715
## - mheight   1   1012240 321998651 48717
## - ppwt      1   2907049 323893461 48743
## - gaweeks   1   4662501 325648912 48766
## - smoken    1   5073849 326060260 48771
## - delwt     1   8137459 329123871 48812
## - mrace     3  14683609 335670021 48894
## - blength   1 102191779 423178191 49903
## - bhead     1 106779754 427766166 49950
step_mod %>% broom::tidy()
## # A tibble: 14 x 5
##    term         estimate std.error statistic   p.value
##    <chr>           <dbl>     <dbl>     <dbl>     <dbl>
##  1 (Intercept) -6099.      138.       -44.3  0.       
##  2 babysex2       28.6       8.45       3.38 7.37e-  4
##  3 bhead         131.        3.45      37.9  3.10e-272
##  4 blength        74.9       2.02      37.1  4.29e-262
##  5 delwt           4.11      0.392     10.5  2.26e- 25
##  6 fincome         0.318     0.175      1.82 6.88e-  2
##  7 gaweeks        11.6       1.46       7.93 2.79e- 15
##  8 mheight         6.59      1.78       3.69 2.23e-  4
##  9 mrace2       -139.        9.91     -14.0  1.21e- 43
## 10 mrace3        -74.9      42.3       -1.77 7.68e-  2
## 11 mrace4       -101.       19.3       -5.21 1.98e-  7
## 12 parity         96.3      40.3        2.39 1.70e-  2
## 13 ppwt           -2.68      0.427     -6.26 4.20e- 10
## 14 smoken         -4.84      0.586     -8.27 1.75e- 16

# Selected model 
step_mod$call
## lm(formula = bwt ~ babysex + bhead + blength + delwt + fincome + 
##     gaweeks + mheight + mrace + parity + ppwt + smoken, data = baby_df)
step_mod$anova
## Stepwise Model Path 
## Analysis of Deviance Table
## 
## Initial Model:
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     pnumlbw + pnumsga + ppbmi + ppwt + smoken + wtgain
## 
## Final Model:
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     mheight + mrace + parity + ppwt + smoken
## 
## 
##         Step Df   Deviance Resid. Df Resid. Dev      AIC
## 1                               4320  320724338 48717.83
## 2   - wtgain  0      0.000      4320  320724338 48717.83
## 3  - pnumsga  0      0.000      4320  320724338 48717.83
## 4  - pnumlbw  0      0.000      4320  320724338 48717.83
## 5    - frace  4 124365.432      4324  320848704 48711.51
## 6  - malform  1   1447.241      4325  320850151 48709.53
## 7    - ppbmi  1   6928.376      4326  320857079 48707.63
## 8   - momage  1  29211.120      4327  320886290 48706.02
## 9 - menarche  1 100121.331      4328  320986412 48705.38
```

  - Below is the plot of model residuals vs. fitted values.

<!-- end list -->

``` r
fit = lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken, data = baby_df)
  
baby_df %>% 
  add_predictions(fit) %>% 
  add_residuals(fit) %>% 
  ggplot(aes(y = resid, x = pred), ) + 
  geom_point(alpha = .2) + 
  labs(
    title = "Plot of model residuals vs. fitted values",
    subtitle = "Stepwise model",
    x = "Fitted Values",
    y = "Residuals"
  )
```

<img src="p8105_hw6_rl3034_files/figure-gfm/unnamed-chunk-1-1.png" width="90%" />

Compare your model to two others:

One using length at birth and gestational age as predictors (main
effects only) One using head circumference, length, sex, and all
interactions (including the three-way interaction) between these

Make this comparison in terms of the cross-validated prediction error;
use crossv\_mc and functions in purrr as appropriate.

Note that although we expect your model to be reasonable, model building
itself is not a main idea of the course and we don’t necessarily expect
your model to be “optimal”.
